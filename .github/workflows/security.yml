name: DevSecOps

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run security scans weekly on Sundays at midnight
    - cron: "0 0 * * 0"

concurrency:
  group: Security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Static Application Security Testing (SAST)
  sast:
    name: SAST - Semgrep
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Semgrep SAST scan
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/default
            p/javascript
            p/typescript
            p/react
            p/nextjs
            p/security-audit
            p/secrets
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('results.sarif') != ''
        with:
          sarif_file: results.sarif
          category: semgrep-sast

  # Software Composition Analysis (SCA)
  sca:
    name: SCA - Dependency Vulnerabilities
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit
        run: pnpm audit --audit-level=moderate || true
        continue-on-error: true

      - name: Run Trivy SCA scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          scanners: "vuln"
          format: "sarif"
          output: "trivy-sca.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"

      - name: Upload Trivy SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy-sca.sarif
          category: trivy-sca

  # Secret Scanning
  secrets:
    name: Secret Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks secret scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true

      - name: Run TruffleHog secret scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
        continue-on-error: true

  # Container Security (for Docker builds)
  container-scan:
    name: Container Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Next.js app
        run: pnpm build

      - name: Build Docker image
        run: |
          # Copy static files into standalone folder structure
          mkdir -p .next/standalone/.next/static
          cp -r .next/static/* .next/standalone/.next/static/ 2>/dev/null || true

          cat > Dockerfile.security-scan <<EOF
          FROM node:22-alpine
          WORKDIR /app
          COPY public ./public
          COPY .next/standalone ./
          ENV NODE_ENV=production
          ENV PORT=3000
          ENV HOSTNAME="0.0.0.0"
          EXPOSE 3000
          CMD ["node", "server.js"]
          EOF
          docker build -f Dockerfile.security-scan -t app:security-scan .

      - name: Run Trivy container scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "app:security-scan"
          format: "sarif"
          output: "trivy-container.sarif"
          severity: "CRITICAL,HIGH"
          vuln-type: "os,library"

      - name: Upload Trivy Container SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-container.sarif') != ''
        with:
          sarif_file: trivy-container.sarif
          category: trivy-container

  # OWASP Dependency Check
  owasp:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "go-gist-signal-server"
          path: "."
          format: "SARIF"
          out: "reports"
          args: >-
            --enableExperimental
            --nodeAuditSkipDevDependencies

      - name: Upload OWASP SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: reports/dependency-check-report.sarif
          category: owasp-dependency-check

  # Security Summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [sast, sca, secrets, container-scan, owasp]
    if: always()
    steps:
      - name: Security scan summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| SAST (Semgrep) | ${{ needs.sast.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SCA (Trivy) | ${{ needs.sca.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Detection | ${{ needs.secrets.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Scan | ${{ needs.container-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OWASP Dependency Check | ${{ needs.owasp.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed findings in the **Security** tab." >> $GITHUB_STEP_SUMMARY
